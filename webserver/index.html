<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
</head>

<body>

    <h1 style="text-align: center" id="peerID">Peerster</h1>

    <div class="originBox"
        style="float:left;height:65vh;width:20%;border:1px solid #bbb;margin:10px;position:relative;">
        <label style="margin:10px;display:inline-block">
            <strong>Origin Box</strong>
        </label>
        <ul id="originList" style="padding:10px;list-style:none;max-height:650px;overflow:auto;">
        </ul>
    </div>
    <div class="chatBox" style="float:left;height:80vh;width:50%;border:1px solid #bbb;margin:10px;position: relative;">
        <label style="margin:10px;display:inline-block;">
            <strong>Chat Box</strong>
        </label>
        <ul id="messageList" style="padding:10px;list-style:none;max-height:650px;overflow:auto;">
        </ul>
        <div style="position:absolute;bottom:0;width:100%">
            <form id="sendForm" style="margin:10px;">
                <input id="messageInput" type="text" placeholder="Write your message" style="width:60%" />
                <button type="submit" style="width:10%;">Send</button>
                <button id="buttonFile" style="width:10%;">Share file</button>
                <button id="buttonDownloadFile" style="width:15%;">Download file</button>
                <input type="file" id="fileInput">
            </form>
        </div>
    </div>
    <div class="nodeBox" style="float:left;height:65vh;width:20%;border:1px solid #bbb;margin:10px;position:relative;">
        <label style="margin:10px;display:inline-block">
            <strong>Node Box</strong>
        </label>
        <ul id="peerList" style="padding:10px;list-style:none;max-height:650px;overflow:auto;">
        </ul>
        <div style="position:absolute;bottom:0;width:100%">
            <form id="peerForm" style="margin:10px;">
                <input id="peerInput" type="text" placeholder="IP:PORT" style="width:65%;" />
                <button type="submit" style="width:25%;">Add</button>
            </form>
        </div>
    </div>
    <script>
        $("#sendForm").submit(function (event) {

event.preventDefault();

var message = document.getElementById("messageInput").value;

if (message == "") {
    return
}

document.getElementById("messageInput").value = "";

$.ajax({
    url: '/message',
    type: 'post',
    data: { text: message, destination: "" },
});
});
$("#peerForm").submit(function (event) {

event.preventDefault();

var peer = document.getElementById("peerInput").value;
document.getElementById("peerInput").value = "";

if (peer == "") {
    return
}

$.ajax({
    url: '/node',
    type: 'post',
    data: peer,
});
updatePeersList()

});

$('#originList').dblclick(function (e) {
var origin = e.target.textContent;
var message = prompt("Enter the message to send to " + origin);
if (message != null && message != "") {
    $.ajax({
        url: '/message',
        type: 'post',
        data: { text: message, destination: origin },
    });
}
});

$('#buttonDownloadFile').click(function (e) {
var requestHex = prompt("Enter the hexadecimal metahash of the file to download");
if (requestHex != null && requestHex != "") {
    var dest = prompt("Enter the name of the peer who has the file");
    if (dest != null && dest != "") {
        var fileName = prompt("Enter the name of the file");
        if (fileName != null && fileName != "") {

            $.ajax({
                url: '/message',
                type: 'post',
                data: { text: "", destination: dest, file: fileName, request: requestHex},
            });
        }
    }
}
});

$("#fileInput").css('opacity', '0');

$("#buttonFile").click(function (e) {
e.preventDefault();
$("#fileInput").trigger('click');
});

$("#fileInput").change(function () {
var input = $(this).val().split(/(\\|\/)/g).pop()
$.ajax({
    url: '/message',
    type: 'post',
    data: { text: "", destination: "", file: input },
});
});


$.get("/id", function (data) {
data = data.replace("\"", "").replace("\"", "")
document.getElementById("peerID").innerHTML = "Peerster - ID: " + data;
});

window.setInterval(function () {
function updateNodeBox() {
    $.get("/node", function (data) {
        var array = JSON.parse(data);

        var list = document.getElementById('peerList');
        while (list.hasChildNodes()) {
            list.removeChild(list.firstChild)
        }

        for (el of array) {
            var entry = document.createElement('li');
            entry.appendChild(document.createTextNode(el));
            list.appendChild(entry);
        }
    });
}
updateNodeBox()

function updateOriginBox() {
    $.get("/origin", function (data) {
        var array = JSON.parse(data);

        var list = document.getElementById('originList');
        while (list.hasChildNodes()) {
            list.removeChild(list.firstChild)
        }

        for (el of array) {
            var entry = document.createElement('li');
            entry.appendChild(document.createTextNode(el));
            list.appendChild(entry);
        }
    });
}
updateOriginBox()

$.get("/message", function (data) {
    var jsonData = JSON.parse(data);
    var list = document.getElementById('messageList');

    for (el of jsonData) {
        var entry = document.createElement('li');
        var text = "[" + el["Origin"] + "] " + el["Text"]
        entry.appendChild(document.createTextNode(text));
        list.appendChild(entry);
    }
});
}, 1000);
    </script>
</body>
</html>