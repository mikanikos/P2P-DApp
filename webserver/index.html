<!DOCTYPE html>
<html>

<head>
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>

    <h1 style="text-align: center" id="peerID">Peerster</h1>

    <div class="chatBox" style="float:left;height:80vh;width:60%;border:1px solid #bbb;margin:10px;position: relative;">
        <label style="margin:10px;display:inline-block;">
            <strong>Chat Box</strong>
        </label>
        <ul id="messageList" style="padding:10px;list-style:none;max-height:650px;overflow:auto;">
        </ul>
        <div style="position:absolute;bottom:0;width:100%">
            <form id="sendForm" style="margin:10px;">
                <input id="messageInput" type="text" placeholder="Write your message" style="width:70%" />
                <button type="submit" style="width:25%;">Send</button>
            </form>
        </div>
    </div>
    <div class="nodeBox" style="float:left;height:65vh;width:35%;border:1px solid #bbb;margin:10px;position:relative;">
        <label style="margin:10px;display:inline-block">
            <strong>Node Box</strong>
        </label>
        <ul id="peerList" style="padding:10px;list-style:none;max-height:650px;overflow:auto;">
        </ul>
        <div style="position:absolute;bottom:0;width:100%">
        <form id="peerForm" style="margin:10px;">
            <input id="peerInput" type="text" placeholder="IP:PORT" style="width:65%;" />
            <button type="submit" style="width:25%;">Add</button>
        </form>
    </div>
    </div>
    <script>
        $("#sendForm").submit(function (event) {

            // Stop form from submitting normally
            event.preventDefault();

            var message = document.getElementById("messageInput").value;

            if (message == "") {
                return
            }

            document.getElementById("messageInput").value = "";

            //alert("wowowo");
            $.ajax({
                url: '/message',
                type: 'post',
                data: message,
            });
        });
        $("#peerForm").submit(function (event) {

            // Stop form from submitting normally
            event.preventDefault();

            var peer = document.getElementById("peerInput").value;
            document.getElementById("peerInput").value = "";

            if (peer == "") {
                return
            }

            //alert("wowowo");
            $.ajax({
                url: '/node',
                type: 'post',
                data: peer,
            });
            updatePeersList()

        });
        $.get("/id", function (data) {
            data = data.replace("\"", "").replace("\"", "")
            document.getElementById("peerID").innerHTML = "Peerster - ID: " + data;
        });
        window.setInterval(function () {
            function updateNodeBox() {
                $.get("/node", function (data) {
                    var array = JSON.parse(data);

                    var list = document.getElementById('peerList');
                    while (list.hasChildNodes()) {
                        list.removeChild(list.firstChild)
                    }

                    for (el of array) {
                        var entry = document.createElement('li');
                        entry.appendChild(document.createTextNode(el));
                        list.appendChild(entry);
                    }
                });
            }
            updateNodeBox()
            $.get("/message", function (data) {              
                var jsonData = JSON.parse(data);
                var list = document.getElementById('messageList');

                // while (list.hasChildNodes()) {
                //     list.removeChild(list.firstChild)
                // }

                var isSimpleMode = jsonData["isSimpleMode"];
                var array = jsonData["messages"];
                for (el of array) {
                    var entry = document.createElement('li');
                    var text
                    if (isSimpleMode == true) {
                        text = "[" + el["Origin"] + "] " + el["Text"]
                    }
                    else {
                        text = "[" + el["Origin"] + "] {" + el["ID"] + "} " + el["Text"]
                    }
                    entry.appendChild(document.createTextNode(text));
                    list.appendChild(entry);
                }
            });
        }, 100);
    </script>
</body>

</html>